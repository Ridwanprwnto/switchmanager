<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Home - Network Switch Manager</title>
        <link rel="icon" href="assets/img/logo.png" />
        <link rel="stylesheet" href="dist/css/jquery.orgchart.css" />
        <link rel="stylesheet" href="assets/css/style.css" />
        <style type="text/css">
            /* === NAVBAR === */
            #navbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: rgba(217, 83, 79, 0.8);
                color: #fff;
                padding: 10px 20px;
                font-size: 16px;
                font-weight: bold;
            }

            #navbar .app-name {
                font-size: 18px;
            }

            #navbar .user-menu {
                position: relative;
                cursor: pointer;
            }

            #navbar .user-menu span {
                font-size: 14px;
            }

            #logout-menu {
                position: absolute;
                top: 30px;
                right: 0;
                background-color: rgba(217, 83, 79, 0.8);
                border-radius: 1px;
                display: none;
                z-index: 1000;
                min-width: 120px;
            }

            #logout-menu ul {
                list-style: none;
                margin: 0;
                padding: 0;
            }

            #logout-menu li {
                padding: 8px 12px;
                cursor: pointer;
                font-size: 14px;
                color: #fff;
            }

            #logout-menu li:hover {
                background: #c74747;
            }

            /* === CHART CONTAINER STYLES === */
            #chart-container {
                height: 500px;
            }

            /* === ORGCHART NODE STYLES === */
            .orgchart.edit-state .edge {
                display: none;
            }
            .orgchart .nodes {
                display: flex !important;
                justify-content: center;
                flex-wrap: wrap;
            }
            .orgchart .node {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                min-width: 180px;
                box-sizing: border-box;
                flex-grow: 1;
                margin: 0 10px 20px 10px;
                position: relative;
            }
            .orgchart .node:first-of-type {
                width: 160px !important;
                min-width: unset;
                flex-grow: 0;
                margin-left: auto;
                margin-right: auto;
            }
            .orgchart .node .title {
                height: 30px;
                line-height: 30px;
                font-weight: bold;
                color: #fff;
                padding-left: 5px;
                border-radius: 4px 4px 0 0;
                width: 100%;
                box-sizing: border-box;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                cursor: pointer;
            }
            .orgchart .node .ip-address-view {
                background-color: white;
                color: black;
                font-size: 0.85rem;
                padding: 4px 5px;
                border-radius: 0 0 4px 4px;
                border: 1px solid #ccc;
                border-top: none;
                height: 24px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                user-select: none;
                width: 100%;
                box-sizing: border-box;
                text-align: center;
            }
            .orgchart .node > .edge {
                cursor: pointer;
                pointer-events: auto;
            }
            .orgchart:not(.edit-state) .node > .edge {
                display: inline-block !important;
            }
            .orgchart .node .toggle-arrow {
                cursor: pointer;
            }

            /* === VALIDATION STYLES === */
            .input-error {
                border: 2px solid #e74c3c !important;
                background-color: #fdf2f2 !important;
            }
            .error-message {
                color: #e74c3c;
                font-size: 0.8rem;
                margin-top: 2px;
                display: block;
            }
            .success-message {
                color: #27ae60;
                font-size: 0.9rem;
                padding: 8px;
                background-color: #d5f4e6;
                border: 1px solid #27ae60;
                border-radius: 4px;
                margin: 10px 0;
            }

            /* === EDIT PANEL STYLES === */
            #edit-panel {
                margin: 0.5rem;
                padding: 0.5rem;
                border: 1px solid #aaa;
            }
            #edit-panel.edit-parent-node .btn-inputs {
                display: none;
            }
            #edit-panel.edit-state > :not(#chart-state-panel) {
                display: none;
            }
            #edit-panel label {
                font-weight: bold;
            }
            #edit-panel.edit-parent-node .selected-node-group {
                display: none;
            }
            #chart-state-panel,
            #selected-node,
            #btn-remove-input {
                margin-right: 1rem;
            }
            #edit-panel button,
            #edit-panel input {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }
            #edit-panel.edit-parent-node button:not(#btn-add-nodes) {
                display: none;
            }
            #new-nodelist {
                display: inline-block;
                list-style: none;
                margin-top: -0.5rem;
                padding: 0;
                vertical-align: text-top;
            }
            #new-nodelist > * {
                padding-bottom: 4px;
            }
            #new-nodelist li {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            #new-nodelist li label {
                font-size: 0.85rem;
                min-width: 25px;
                display: inline-block;
            }
            .radio-panel input[type="radio"] {
                height: 1.25rem;
                width: 1.25rem;
                vertical-align: text-bottom;
            }
            #btn-add-nodes {
                margin-left: 20px;
            }

            /* === CH CONTAINER STYLES === */
            #ch-container {
                margin: 0.5rem;
                padding: 0.5rem;
                border: 1px solid #aaa;
                position: relative;
            }
            #ch-mode-panel {
                margin: 0 10px 20px 0;
                font-weight: bold;
            }
            #node-info {
                margin-left: 5px;
                margin-bottom: 1rem;
                font-weight: bold;
            }
            #node-info label,
            #node-info input {
                font-size: 0.9rem;
                margin-right: 10px;
            }
            #node-info input {
                padding: 0.3rem 0.5rem;
                width: 180px;
                box-sizing: border-box;
                border-radius: 3px;
                border: 1px solid #ccc;
            }
            #ch-list {
                margin: 0 10px 20px 5px;
                padding: 0;
                list-style: none;
            }
            #ch-list li {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
                margin-bottom: 0.5rem;
                position: relative;
            }
            #ch-list label {
                min-width: 50px;
                font-weight: bold;
                font-size: 0.9rem;
                color: #333;
            }
            #ch-list input[type="checkbox"] {
                width: 20px;
                height: 20px;
                margin-right: 5px;
                vertical-align: middle;
            }
            #ch-list input[type="text"],
            #ch-list select,
            #ch-list span {
                flex: 1 1 120px;
                padding: 0.3rem 0.5rem;
                border: 1px solid #ccc;
                border-radius: 3px;
            }
            #ch-list span {
                border: none;
                padding-left: 0;
                background: transparent;
                line-height: 1.7em;
            }
            #btn-update-ch {
                padding: 0.5rem 1.5rem;
                font-size: 1rem;
                border: 1px solid #333;
                border-radius: 3px;
                cursor: pointer;
                transition: background-color 0.2s ease-in-out;
            }
            #btn-update-ch:hover {
                background-color: #ddd;
            }
            #btn-save-ch {
                padding: 0.5rem 1.5rem;
                font-size: 1rem;
                border: 1px solid #333;
                border-radius: 3px;
                cursor: pointer;
                transition: background-color 0.2s ease-in-out;
            }
            #btn-save-ch:hover {
                background-color: #ddd;
            }
            #ch-add-btn {
                margin-left: 5px;
                padding: 0.5rem 1.5rem;
                font-size: 1rem;
                cursor: pointer;
                border: 1px solid #333;
                border-radius: 3px;
                transition: background-color 0.2s ease-in-out;
            }
            #ch-add-btn:hover {
                background-color: #ddd;
            }
            .ch-remove-btn {
                margin-left: 8px;
                padding: 2px 8px;
                font-size: 0.8rem;
                cursor: pointer;
                border: 1px solid #333;
                border-radius: 3px;
                user-select: none;
                height: 26px;
                align-self: center;
                flex-shrink: 0;
                font-weight: bold;
            }
            .ch-remove-btn:hover {
                background-color: #ddd;
            }

            /* === FOOTER === */
            #footer {
                margin-top: 10px;
                padding: 10px;
                text-align: center;
                font-size: 16px;
                color: #555;
                border-top: 1px solid #ddd;
            }
        </style>
    </head>
    <body>
        <!-- === NAVBAR === -->
        <div id="navbar">
            <div class="app-name">Network Switch Manager</div>
            <div class="user-menu">
                <span id="user-name">Hi, Admin (1234567890)</span>
                <div id="logout-menu" class="hidden">
                    <ul>
                        <li id="btn-logout">Logout</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- === CHART CONTAINER === -->
        <div id="chart-container"></div>
        <div id="edit-panel">
            <span id="chart-state-panel" class="radio-panel">
                <input type="radio" name="chart-state" id="rd-view" value="view" />
                <label for="rd-view">View</label>
                <input type="radio" name="chart-state" id="rd-edit" value="edit" checked="true" />
                <label for="rd-edit">Edit</label>
            </span>
            <label class="selected-node-group">Selected node:</label>
            <input type="text" id="selected-node" class="selected-node-group" placeholder="Select node" readonly />
            <label>New node:</label>
            <ul id="new-nodelist">
                <li>
                    <input type="text" class="new-node" placeholder="Switch name" />
                    <input type="text" class="new-ip" placeholder="IP address" />
                    <input type="text" class="new-jenis" placeholder="Jenis switch" />
                    <input type="text" class="new-sn" placeholder="Serial number" />
                </li>
            </ul>
            <button class="btn-inputs" id="btn-add-input" title="Add new node input pair">+</button>
            <button class="btn-inputs" id="btn-remove-input" title="Remove last node input pair">-</button>
            <span id="node-type-panel" class="radio-panel">
                <input type="radio" name="node-type" id="rd-parent" value="parent" />
                <label for="rd-parent">Parent(root)</label>
                <input type="radio" name="node-type" id="rd-child" value="children" />
                <label for="rd-child">Child</label>
            </span>
            <button type="button" id="btn-add-nodes">Add</button>
            <button type="button" id="btn-delete-nodes">Delete</button>
            <button type="button" id="btn-reset">Reset</button>
        </div>
        <!-- === CH-CONTAINER === -->
        <div id="ch-container" style="display: none">
            <div id="ch-mode-panel" class="radio-panel">
                <input type="radio" name="ch-mode" id="ch-view" value="view" checked />
                <label for="ch-view">View</label>
                <input type="radio" name="ch-mode" id="ch-edit" value="edit" />
                <label for="ch-edit">Edit</label>
            </div>
            <div id="node-info">
                <label for="node-name">Name:</label>
                <input type="text" id="node-name" />
                <label for="node-ip">IP:</label>
                <input type="text" id="node-ip" />
                <label for="node-jenis">Jenis:</label>
                <input type="text" id="node-jenis" />
                <label for="node-sn">SN:</label>
                <input type="text" id="node-sn" />
            </div>
            <ul id="ch-list"></ul>
            <button id="ch-add-btn" type="button" style="display: none" title="Add Port">Add</button>
            <button id="btn-update-ch" type="button" style="display: none">Update</button>
            <button id="btn-save-ch" type="button" style="display: none">Save</button>
        </div>
        <!-- === FOOTER === -->
        <div id="footer">
            &copy; 2024 Developed by
            <a href="https://ridwanpurwanto-blog.vercel.app" target="_blank"> Purwanto Ridwan</a>
        </div>
        <script type="text/javascript" src="dist/js/jquery.min.js"></script>
        <script type="text/javascript" src="dist/js/html2canvas.min.js"></script>
        <script type="text/javascript" src="dist/js/jquery.orgchart.js"></script>
        <script type="text/javascript">
            $(function () {
                // === DATA CONFIGURATION ===
                const CONFIG = {
                    MAX_PORTS: 48,
                    MIN_PORT: 1,
                    IP_REGEX: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,
                    SWITCH_NAME_REGEX: /^[A-Z0-9\-_]+$/i,
                };

                // === DATA SOURCE ===
                var datascource = {
                    id: "1",
                    name: "SW-RUANG-SERVER",
                    ip: "192.168.0.1",
                    jenis: "Core Switch",
                    sn: "SN-001",
                    ch: [
                        { port: "01", segment: "192.168.0.1", trunk: "N", status: "N", ip: "192.168.0.101", keterangan: "Port 01 uplink" },
                        { port: "02", segment: "192.168.0.2", trunk: "N", status: "N", ip: "192.168.0.102", keterangan: "Port 02 printer" },
                        { port: "03", segment: "192.168.0.3", trunk: "N", status: "N", ip: "192.168.0.103", keterangan: "Port 03 office PC" },
                        { port: "04", segment: "192.168.0.4", trunk: "N", status: "N", ip: "192.168.0.104", keterangan: "Port 04 admin PC" },
                        { port: "05", segment: "192.168.0.5", trunk: "N", status: "N", ip: "192.168.0.105", keterangan: "Port 05 WiFi AP" },
                        { port: "06", segment: "192.168.0.6", trunk: "N", status: "N", ip: "192.168.0.106", keterangan: "Port 06 IP Phone" },
                        { port: "07", segment: "192.168.0.7", trunk: "N", status: "N", ip: "192.168.0.107", keterangan: "Port 07 conference room" },
                        { port: "08", segment: "192.168.0.8", trunk: "N", status: "N", ip: "192.168.0.108", keterangan: "Port 08 security cam" },
                        { port: "09", segment: "192.168.0.9", trunk: "N", status: "N", ip: "192.168.0.109", keterangan: "Port 09 guest network" },
                        { port: "10", segment: "192.168.0.10", trunk: "Y", status: "N", ip: "192.168.0.110", keterangan: "Port 10 trunk to core" },
                    ],
                    children: [
                        {
                            id: "2",
                            name: "SW-GATE-RCV",
                            ip: "192.168.0.2",
                            jenis: "Core Switch",
                            sn: "SN-002",
                            ch: [
                                { port: "01", segment: "192.168.0.1", trunk: "N", status: "N", ip: "192.168.0.201", keterangan: "Gate port 01" },
                                { port: "02", segment: "192.168.0.2", trunk: "N", status: "N", ip: "192.168.0.202", keterangan: "Gate port 02" },
                                { port: "03", segment: "192.168.0.3", trunk: "N", status: "N", ip: "192.168.0.203", keterangan: "Gate port 03" },
                                { port: "04", segment: "192.168.0.4", trunk: "N", status: "N", ip: "192.168.0.204", keterangan: "Gate port 04" },
                                { port: "05", segment: "192.168.0.5", trunk: "N", status: "N", ip: "192.168.0.205", keterangan: "Gate port 05" },
                                { port: "06", segment: "192.168.0.6", trunk: "N", status: "N", ip: "192.168.0.206", keterangan: "Gate port 06" },
                                { port: "07", segment: "192.168.0.7", trunk: "N", status: "N", ip: "192.168.0.207", keterangan: "Gate port 07" },
                                { port: "08", segment: "192.168.0.8", trunk: "N", status: "N", ip: "192.168.0.208", keterangan: "Gate port 08" },
                                { port: "09", segment: "192.168.0.9", trunk: "N", status: "N", ip: "192.168.0.209", keterangan: "Gate port 09" },
                                { port: "10", segment: "192.168.0.10", trunk: "Y", status: "N", ip: "192.168.0.210", keterangan: "Gate trunk port 10" },
                            ],
                        },
                        {
                            id: "3",
                            name: "SW-RUANG-ADMIN",
                            ip: "192.168.0.3",
                            jenis: "Core Switch",
                            sn: "SN-003",
                            ch: [
                                { port: "01", segment: "192.168.0.1", trunk: "N", status: "N", ip: "192.168.0.31", keterangan: "Admin port 01" },
                                { port: "02", segment: "192.168.0.2", trunk: "N", status: "N", ip: "192.168.0.32", keterangan: "Admin port 02" },
                                { port: "03", segment: "192.168.0.3", trunk: "N", status: "N", ip: "192.168.0.33", keterangan: "Admin port 03" },
                                { port: "04", segment: "192.168.0.4", trunk: "N", status: "N", ip: "192.168.0.34", keterangan: "Admin port 04" },
                                { port: "05", segment: "192.168.0.5", trunk: "N", status: "N", ip: "192.168.0.35", keterangan: "Admin port 05" },
                                { port: "06", segment: "192.168.0.6", trunk: "N", status: "N", ip: "192.168.0.36", keterangan: "Admin port 06" },
                                { port: "07", segment: "192.168.0.7", trunk: "N", status: "N", ip: "192.168.0.37", keterangan: "Admin port 07" },
                                { port: "08", segment: "192.168.0.8", trunk: "N", status: "N", ip: "192.168.0.38", keterangan: "Admin port 08" },
                                { port: "09", segment: "192.168.0.9", trunk: "N", status: "N", ip: "192.168.0.39", keterangan: "Admin port 09" },
                                { port: "10", segment: "192.168.0.10", trunk: "Y", status: "N", ip: "192.168.0.40", keterangan: "Admin trunk port 10" },
                            ],
                        },
                        {
                            id: "4",
                            name: "SW-CCTV",
                            ip: "192.168.0.4",
                            jenis: "Core Switch",
                            sn: "SN-004",
                            ch: [
                                { port: "01", segment: "192.168.0.1", trunk: "N", status: "N", ip: "192.168.0.41", keterangan: "CCTV port 01" },
                                { port: "02", segment: "192.168.0.2", trunk: "N", status: "N", ip: "192.168.0.42", keterangan: "CCTV port 02" },
                                { port: "03", segment: "192.168.0.3", trunk: "N", status: "N", ip: "192.168.0.43", keterangan: "CCTV port 03" },
                                { port: "04", segment: "192.168.0.4", trunk: "N", status: "N", ip: "192.168.0.44", keterangan: "CCTV port 04" },
                                { port: "05", segment: "192.168.0.5", trunk: "N", status: "N", ip: "192.168.0.45", keterangan: "CCTV port 05" },
                                { port: "06", segment: "192.168.0.6", trunk: "N", status: "N", ip: "192.168.0.46", keterangan: "CCTV port 06" },
                                { port: "07", segment: "192.168.0.7", trunk: "N", status: "N", ip: "192.168.0.47", keterangan: "CCTV port 07" },
                                { port: "08", segment: "192.168.0.8", trunk: "N", status: "N", ip: "192.168.0.48", keterangan: "CCTV port 08" },
                                { port: "09", segment: "192.168.0.9", trunk: "N", status: "N", ip: "192.168.0.49", keterangan: "CCTV port 09" },
                                { port: "10", segment: "192.168.0.10", trunk: "Y", status: "N", ip: "192.168.0.50", keterangan: "CCTV trunk port 10" },
                            ],
                        },
                    ],
                };

                // === UTILITY FUNCTIONS ===
                function getId() {
                    return new Date().getTime() * 1000 + Math.floor(Math.random() * 1001);
                }

                function showMessage(message, type = "success") {
                    const messageClass = type === "error" ? "error-message" : "success-message";
                    const messageEl = $(`<div class="${messageClass}">${message}</div>`);
                    $("#edit-panel").prepend(messageEl);
                    setTimeout(() => messageEl.fadeOut(() => messageEl.remove()), 3000);
                }

                function clearValidationErrors() {
                    $(".input-error").removeClass("input-error");
                    $(".error-message").remove();
                }

                // === Collapse State Helpers ===
                function getCollapseState() {
                    const state = {};
                    if (!oc || !oc.$chart) return state;
                    oc.$chart.find(".node").each(function () {
                        const nodeId = $(this).attr("id");
                        if ($(this).closest(".isCollapsedDescendant, .isChildrenCollapsed, .isSiblingsCollapsed, .isCollapsedSibling").length) {
                            state[nodeId] = "collapsed";
                        } else {
                            state[nodeId] = "expanded";
                        }
                    });
                    return state;
                }

                function applyCollapseState(state) {
                    if (!oc || !oc.$chart) return;
                    oc.$chart.find(".node").each(function () {
                        const nodeId = $(this).attr("id");
                        if (state[nodeId] === "collapsed") {
                            oc.hideDescendants($(this));
                        }
                    });
                }

                // === FUNGSI UNTUK MENAMBAHKAN TOGGLE ARROWS ===
                function addToggleArrows() {
                    if (!oc || !oc.$chart) return;

                    // Hapus semua toggle arrow yang sudah ada untuk menghindari duplikasi
                    oc.$chart.find(".toggle-arrow").remove();

                    // Tambahkan toggle arrow untuk setiap node yang memiliki children
                    oc.$chart.find(".node").each(function () {
                        const $node = $(this);
                        const nodeName = $node.find(".title").text();
                        const nodeData = findNodeDataByName(datascource, nodeName);

                        // Cek apakah node ini memiliki children di data
                        if (nodeData && nodeData.children && nodeData.children.length > 0) {
                            // Cek apakah toggle arrow belum ada
                            if ($node.find(".toggle-arrow").length === 0) {
                                const $toggleArrow = $("<i>", {
                                    class: "fa fa-bars toggle-arrow",
                                    title: "Expand/Collapse",
                                });
                                $node.append($toggleArrow);
                            }
                        }
                    });
                }

                // === VALIDATION FUNCTIONS ===
                function validateIP(ip) {
                    if (!ip || !CONFIG.IP_REGEX.test(ip)) {
                        return false;
                    }
                    const parts = ip.split(".");
                    return parts.every((part) => {
                        const num = parseInt(part, 10);
                        return num >= 0 && num <= 255;
                    });
                }

                function validateSwitchName(name) {
                    return name && name.trim().length > 0 && CONFIG.SWITCH_NAME_REGEX.test(name.trim());
                }

                function checkDuplicateSN(newSN, excludeName = "") {
                    function searchSN(node) {
                        if (node.name !== excludeName && node.sn === newSN) {
                            return true;
                        }
                        if (node.children) {
                            return node.children.some(searchSN);
                        }
                        return false;
                    }
                    return searchSN(datascource);
                }

                function validatePortNumber(port) {
                    const portNum = parseInt(port, 10);
                    return !isNaN(portNum) && portNum >= CONFIG.MIN_PORT && portNum <= CONFIG.MAX_PORTS;
                }

                function showValidationError(element, message) {
                    element.addClass("input-error");
                    const errorSpan = $(`<span class="error-message">${message}</span>`);
                    element.after(errorSpan);
                }

                function validateNodeInputs() {
                    clearValidationErrors();
                    let isValid = true;
                    const errors = [];

                    const names = [];
                    const ips = [];
                    const sns = [];

                    $("#new-nodelist li").each(function () {
                        const $nameInput = $(this).find(".new-node");
                        const $ipInput = $(this).find(".new-ip");
                        const $snInput = $(this).find(".new-sn");

                        const name = $nameInput.val().trim();
                        const ip = $ipInput.val().trim();
                        const sn = $snInput.val().trim();

                        // === Cek kosong & format ===
                        if (!name) {
                            showValidationError($nameInput, "Nama switch tidak boleh kosong");
                            errors.push("Nama switch tidak boleh kosong");
                            isValid = false;
                        } else if (!validateSwitchName(name)) {
                            showValidationError($nameInput, "Format nama switch tidak valid (huruf, angka, - atau _)");
                            errors.push("Format nama switch tidak valid");
                            isValid = false;
                        }

                        if (!ip) {
                            showValidationError($ipInput, "IP address tidak boleh kosong");
                            errors.push("IP address tidak boleh kosong");
                            isValid = false;
                        } else if (!validateIP(ip)) {
                            showValidationError($ipInput, "Format IP address tidak valid");
                            errors.push("Format IP address tidak valid");
                            isValid = false;
                        }

                        if (!sn) {
                            showValidationError($snInput, "SN switch tidak boleh kosong");
                            errors.push("SN switch tidak boleh kosong");
                            isValid = false;
                        } else if (!validateSwitchName(sn)) {
                            showValidationError($snInput, "Format SN tidak valid (huruf, angka, - atau _)");
                            errors.push("Format SN tidak valid");
                            isValid = false;
                        }

                        // === Cek duplikat antar input baru ===
                        if (names.includes(name)) {
                            showValidationError($nameInput, `Nama "${name}" duplikat di input`);
                            errors.push(`Nama "${name}" duplikat di input`);
                            isValid = false;
                        }
                        if (ips.includes(ip)) {
                            showValidationError($ipInput, `IP "${ip}" duplikat di input`);
                            errors.push(`IP "${ip}" duplikat di input`);
                            isValid = false;
                        }
                        if (sns.includes(sn)) {
                            showValidationError($snInput, `SN "${sn}" duplikat di input`);
                            errors.push(`SN "${sn}" duplikat di input`);
                            isValid = false;
                        }

                        names.push(name);
                        ips.push(ip);
                        sns.push(sn);

                        // === Cek duplikat dengan datascource lama ===
                        if (checkDuplicateName(name)) {
                            showValidationError($nameInput, `Nama switch "${name}" sudah ada`);
                            errors.push(`Nama switch "${name}" sudah ada`);
                            isValid = false;
                        }
                        if (checkDuplicateIP(ip)) {
                            showValidationError($ipInput, `IP "${ip}" sudah digunakan`);
                            errors.push(`IP "${ip}" sudah digunakan`);
                            isValid = false;
                        }
                        if (checkDuplicateSN(sn)) {
                            showValidationError($snInput, `SN "${sn}" sudah digunakan`);
                            errors.push(`SN "${sn}" sudah digunakan`);
                            isValid = false;
                        }
                    });

                    return { isValid, errors };
                }

                function checkDuplicateIP(newIP, excludeName = "") {
                    function searchIP(node) {
                        if (node.name !== excludeName && node.ip === newIP) {
                            return true;
                        }
                        if (node.children) {
                            return node.children.some(searchIP);
                        }
                        return false;
                    }
                    return searchIP(datascource);
                }

                function checkDuplicateName(newName, excludeName = "") {
                    function searchName(node) {
                        if (node.name !== excludeName && node.name === newName) {
                            return true;
                        }
                        if (node.children) {
                            return node.children.some(searchName);
                        }
                        return false;
                    }
                    return searchName(datascource);
                }

                // === CORE FUNCTIONS ===
                var oc;

                function findNodeDataByName(node, name) {
                    if (node.name === name) return node;
                    if (!node.children) return null;
                    for (var child of node.children) {
                        var found = findNodeDataByName(child, name);
                        if (found) return found;
                    }
                    return null;
                }

                function findNodeByName(node, name) {
                    if (node.name === name) return node;
                    if (!node.children) return null;
                    for (var c of node.children) {
                        var found = findNodeByName(c, name);
                        if (found) return found;
                    }
                    return null;
                }

                function removeNodeByName(node, name) {
                    if (!node.children) return;
                    node.children = node.children.filter((c) => c.name !== name);
                    node.children.forEach((c) => removeNodeByName(c, name));
                }

                function clearSelection() {
                    $("#selected-node").val("").data("node", null);
                    $("#ch-add-btn").hide();
                    $("#btn-update-ch").hide();
                    $("#btn-save-ch").hide();
                    $("#ch-list").empty();
                    $("#ch-container").hide();
                    $(".orgchart").find(".focused").removeClass("focused");
                    $("#new-nodelist").children("li:not(:first)").remove();
                    $("#new-nodelist").find("input").val("");
                    $("#node-type-panel").find("input").prop("checked", false);
                    clearValidationErrors();
                }

                function renderChart(collapseStateBefore) {
                    try {
                        if (oc) {
                            oc.$chartContainer.empty();
                        }
                        oc = $("#chart-container").orgchart({
                            data: datascource,
                            createNode: function ($node, data) {
                                if (!data.id) {
                                    data.id = getId();
                                }
                                $node[0].id = data.id;

                                var ipText = data.ip ? data.ip : "IP not set";
                                var ipView = $('<div class="ip-address-view"></div>').text(ipText);
                                $node.append(ipView);

                                // Paksa toggle hamburger kalau ada children
                                if (data.children && data.children.length > 0) {
                                    $node.find(".toggle-arrow").remove(); // bersihkan biar tidak dobel
                                    $("<i>", {
                                        class: "fa fa-bars toggle-arrow",
                                        title: "Expand/Collapse",
                                    }).appendTo($node);
                                }
                            },
                        });

                        // === APPLY collapse state jika ada yang disimpan ===
                        if (collapseStateBefore) {
                            applyCollapseState(collapseStateBefore);
                        }

                        // === TAMBAHKAN TOGGLE ARROWS SETELAH CHART DIRENDER ===
                        setTimeout(function () {
                            addToggleArrows();
                        }, 100);

                        oc.$chartContainer.off("click", ".node");
                        oc.$chartContainer.on("click", ".node", function () {
                            var $this = $(this);
                            var nodeName = $this.find(".title").text();
                            $("#selected-node").val(nodeName).data("node", $this);
                            var nodeData = findNodeDataByName(datascource, nodeName);
                            if (nodeData) {
                                if (!nodeData.ch) {
                                    nodeData.ch = [];
                                }
                                $("#ch-container").show();
                                renderChInputs(nodeData.ch, $('input[name="ch-mode"]:checked').val(), nodeData);
                            } else {
                                $("#ch-container").hide();
                                $("#ch-list").empty();
                                $("#ch-add-btn").hide();
                                $("#btn-update-ch").hide();
                                $("#btn-save-ch").hide();
                            }
                        });

                        oc.$chartContainer.off("click", ".orgchart");
                        oc.$chartContainer.on("click", ".orgchart", function (event) {
                            if (!$(event.target).closest(".node").length) {
                                clearSelection();
                            }
                        });
                    } catch (error) {
                        console.error("Error rendering chart:", error);
                        showMessage("Error dalam merender chart: " + error.message, "error");
                    }
                }

                function renderChInputs(chArray, mode, node) {
                    try {
                        var $list = $("#ch-list");
                        $list.empty();
                        if (node) {
                            $("#node-name").val(node.name);
                            $("#node-ip").val(node.ip || "");
                            $("#node-jenis").val(node.jenis || "");
                            $("#node-sn").val(node.sn || "");
                            if (mode === "edit") {
                                $("#node-name, #node-ip, #node-jenis, #node-sn").prop("readonly", false);
                                $("#ch-add-btn").show();
                            } else {
                                $("#node-name, #node-ip, #node-jenis, #node-sn").prop("readonly", true);
                                $("#ch-add-btn").hide();
                            }
                        }

                        chArray.forEach(function (portObj, index) {
                            var $li = $("<li></li>");
                            var $portLabel = $("<label></label>").text("Port:");
                            var $portInput = $('<input type="text" readonly>').val(portObj.port);
                            var $segLabel = $("<label></label>").text("Segment:");
                            var $segInput = $('<input type="text" class="ch-segment" data-index="' + index + '">').val(portObj.segment);
                            if (mode !== "edit") $segInput.prop("readonly", true);

                            var $ipLabel = $("<label></label>").text("IP Address:");
                            var $ipInput = $('<input type="text" class="ch-ip" data-index="' + index + '">').val(portObj.ip);
                            if (mode !== "edit") $ipInput.prop("readonly", true);

                            var $ketLabel = $("<label></label>").text("Keterangan:");
                            var $ketInput = $('<input type="text" class="ch-keterangan" data-index="' + index + '">').val(portObj.keterangan);
                            if (mode !== "edit") $ketInput.prop("readonly", true);

                            var $trunkLabel = $("<label></label>").text("Trunk:");
                            var $trunkInput = $('<input type="checkbox" class="ch-trunk" data-index="' + index + '">').prop("checked", portObj.trunk === "Y");
                            if (mode !== "edit") $trunkInput.prop("disabled", true);

                            var $statusLabel = $("<label></label>").text("Status:");
                            var $statusInput = $('<input type="checkbox" class="ch-status" data-index="' + index + '">').prop("checked", portObj.status === "Y");
                            if (mode !== "edit") $statusInput.prop("disabled", true);

                            var $removeBtn = null;
                            if (mode === "edit") {
                                $removeBtn = $('<button type="button" class="ch-remove-btn" title="Remove Port">−</button>');
                                $removeBtn.on("click", function () {
                                    if (confirm("Apakah Anda yakin ingin menghapus port ini?")) {
                                        chArray.splice(index, 1);
                                        renderChInputs(chArray, mode, node);
                                        showMessage("Port berhasil dihapus", "success");
                                    }
                                });
                            }

                            $li.append($portLabel, $portInput, $segLabel, $segInput, $ipLabel, $ipInput, $ketLabel, $ketInput, $trunkLabel, $trunkInput, $statusLabel, $statusInput);
                            if ($removeBtn) {
                                $li.append($removeBtn);
                            }
                            $list.append($li);
                        });

                        if (mode === "edit" && chArray.length > 0) {
                            $("#btn-update-ch").show();
                            $("#btn-save-ch").show();
                        } else {
                            $("#btn-update-ch").hide();
                            $("#btn-save-ch").hide();
                        }
                    } catch (error) {
                        console.error("Error rendering port inputs:", error);
                        showMessage("Error dalam merender input port: " + error.message, "error");
                    }
                }

                // === EVENT HANDLERS ===

                // Initialize chart
                renderChart();

                // Input formatting for switch names and IPs
                $(document).on("input", "input[type=text]", function () {
                    var start = this.selectionStart;
                    var end = this.selectionEnd;
                    this.value = this.value.toUpperCase();
                    this.setSelectionRange(start, end);

                    // Real-time validation
                    clearValidationErrors();
                });

                // Chart state toggle
                $('input[name="chart-state"]').on("click", function () {
                    var isEdit = this.value === "edit";
                    $(".orgchart").toggleClass("edit-state", isEdit);
                    $("#edit-panel").toggleClass("edit-state", !isEdit);
                    if (isEdit) {
                        $(".orgchart")
                            .find(".hidden")
                            .removeClass("hidden")
                            .end()
                            .find(".hierarchy")
                            .removeClass("isCollapsedDescendant isChildrenCollapsed isSiblingsCollapsed isCollapsedSibling")
                            .find(".node")
                            .removeClass("slide-up slide-down slide-right slide-left");
                    } else {
                        $("#btn-reset").trigger("click");
                    }
                });

                // Node type selection
                $('input[name="node-type"]').on("click", function () {
                    var $this = $(this);
                    clearValidationErrors();
                    if ($this.val() === "parent") {
                        $("#edit-panel").addClass("edit-parent-node");
                        $("#new-nodelist").children(":gt(0)").remove();
                    } else {
                        $("#edit-panel").removeClass("edit-parent-node");
                    }
                });

                // Add node input
                $("#btn-add-input").on("click", function () {
                    $("#new-nodelist").append(
                        "<li>" +
                            '<input type="text" class="new-node" placeholder="Switch name" />' +
                            '<input type="text" class="new-ip" placeholder="IP address" />' +
                            '<input type="text" class="new-jenis" placeholder="Jenis switch" />' +
                            '<input type="text" class="new-sn" placeholder="Serial Number" />' +
                            "</li>"
                    );
                });

                // Remove node input
                $("#btn-remove-input").on("click", function () {
                    var inputs = $("#new-nodelist").children("li");
                    if (inputs.length > 1) {
                        inputs.last().remove();
                        clearValidationErrors();
                    }
                });

                // Add nodes
                $("#btn-add-nodes").on("click", function () {
                    try {
                        const validation = validateNodeInputs();
                        if (!validation.isValid) {
                            showMessage("Harap perbaiki error validasi sebelum menambah node", "error");
                            return;
                        }

                        var $chartContainer = $("#chart-container");
                        var nodeVals = [];
                        var ipVals = [];
                        var jenisVals = [];
                        var snVals = [];

                        $("#new-nodelist")
                            .children("li")
                            .each(function () {
                                var nodeName = $(this).find(".new-node").val().trim();
                                var ipAddr = $(this).find(".new-ip").val().trim();
                                var jenis = $(this).find(".new-jenis").val().trim();
                                var sn = $(this).find(".new-sn").val().trim();
                                nodeVals.push(nodeName);
                                ipVals.push(ipAddr);
                                jenisVals.push(jenis);
                                snVals.push(sn);
                            });

                        // Check for duplicates
                        for (let i = 0; i < nodeVals.length; i++) {
                            if (checkDuplicateName(nodeVals[i])) {
                                showMessage(`Nama switch "${nodeVals[i]}" sudah ada`, "error");
                                return;
                            }
                            if (checkDuplicateIP(ipVals[i])) {
                                showMessage(`IP address "${ipVals[i]}" sudah digunakan`, "error");
                                return;
                            }
                        }

                        var nodeType = $('input[name="node-type"]:checked');
                        if (!nodeType.length) {
                            showMessage("Silakan pilih tipe node", "error");
                            return;
                        }

                        var $node = $("#selected-node").data("node");
                        if (nodeType.val() !== "parent") {
                            if (!$("#selected-node").val() || !$node) {
                                showMessage("Silakan pilih satu node di orgchart", "error");
                                return;
                            }
                        }

                        if (nodeType.val() !== "parent" && !$(".orgchart").length) {
                            showMessage("Silakan buat root node terlebih dahulu", "error");
                            return;
                        }

                        if (nodeType.val() === "parent") {
                            if (!$chartContainer.children(".orgchart").length) {
                                // kasus pertama kali buat root
                                datascource = {
                                    id: getId(),
                                    name: nodeVals[0],
                                    ip: ipVals[0],
                                    ch: [],
                                    children: [],
                                };
                                renderChart();
                            } else {
                                // simpan root lama
                                const oldRoot = datascource;

                                // buat root baru, root lama jadi child
                                datascource = {
                                    id: getId(),
                                    name: nodeVals[0],
                                    ip: ipVals[0],
                                    ch: [],
                                    children: [oldRoot],
                                };

                                renderChart();
                            }
                        } else {
                            if (!$node.siblings(".nodes").length) {
                                var rel = nodeVals.length > 1 ? "110" : "100";
                                oc.addChildren(
                                    $node,
                                    nodeVals.map(function (item, index) {
                                        return {
                                            id: getId(),
                                            name: item,
                                            ip: ipVals[index],
                                            jenis: jenisVals[index],
                                            sn: snVals[index],
                                            ch: [],
                                            children: [],
                                            relationship: rel,
                                        };
                                    })
                                );
                            } else {
                                oc.addSiblings(
                                    $node.siblings(".nodes").find(".node:first"),
                                    nodeVals.map(function (item, index) {
                                        return {
                                            id: getId(),
                                            name: item,
                                            ip: ipVals[index],
                                            jenis: jenisVals[index],
                                            sn: snVals[index],
                                            ch: [],
                                            children: [],
                                            relationship: "110",
                                        };
                                    })
                                );
                            }

                            var selectedName = $node.find(".title").text();
                            var parentNodeObject = findNodeByName(datascource, selectedName);
                            if (parentNodeObject) {
                                if (!parentNodeObject.children) parentNodeObject.children = [];
                                nodeVals.forEach((item, i) => {
                                    parentNodeObject.children.push({
                                        id: getId(),
                                        name: item,
                                        ip: ipVals[i],
                                        jenis: jenisVals[i],
                                        sn: snVals[i],
                                        ch: [],
                                        children: [],
                                        relationship: "100",
                                    });
                                });
                            }
                        }

                        // === TAMBAHKAN TOGGLE ARROWS SETELAH MENAMBAH NODE ===
                        setTimeout(function () {
                            addToggleArrows();
                        }, 100);

                        $("#new-nodelist").find("input").val("");
                        clearValidationErrors();
                        showMessage(`${nodeVals.length} node berhasil ditambahkan`, "success");
                    } catch (error) {
                        console.error("Error adding nodes:", error);
                        showMessage("Error dalam menambah node: " + error.message, "error");
                    }
                });

                // Delete nodes
                $("#btn-delete-nodes").on("click", function () {
                    if (confirm("Apakah Anda yakin ingin menghapus node ini?")) {
                        try {
                            var $node = $("#selected-node").data("node");
                            if (!$node) {
                                showMessage("Silakan pilih satu node di orgchart", "error");
                                return;
                            } else if ($node[0] === $(".orgchart").find(".node:first")[0]) {
                                if (!window.confirm("Apakah Anda yakin ingin menghapus seluruh chart?")) {
                                    return;
                                }
                                datascource = {};
                            }

                            var nodeNameToDelete = $node.find(".title").text();
                            oc.removeNodes($node);

                            if (datascource.name !== nodeNameToDelete) {
                                removeNodeByName(datascource, nodeNameToDelete);
                            } else {
                                datascource = {};
                            }

                            $("#selected-node").val("").data("node", null);
                            renderChart();
                            clearSelection();
                            showMessage("Node berhasil dihapus", "success");
                        } catch (error) {
                            console.error("Error deleting node:", error);
                            showMessage("Error dalam menghapus node: " + error.message, "error");
                        }
                    }
                });

                // Reset form
                $("#btn-reset").on("click", function () {
                    clearSelection();
                });

                // Add port
                $("#ch-add-btn").on("click", function () {
                    try {
                        var nodeName = $("#selected-node").val();
                        if (!nodeName) {
                            showMessage("Tidak ada node yang dipilih", "error");
                            return;
                        }

                        var nodeData = findNodeDataByName(datascource, nodeName);
                        if (!nodeData) {
                            showMessage("Data node yang dipilih tidak ditemukan", "error");
                            return;
                        }

                        if (!nodeData.ch) {
                            nodeData.ch = [];
                        }

                        if (nodeData.ch.length >= CONFIG.MAX_PORTS) {
                            showMessage(`Maksimal ${CONFIG.MAX_PORTS} port per switch`, "error");
                            return;
                        }

                        var maxPortNumber = 0;
                        nodeData.ch.forEach(function (c) {
                            var pNum = parseInt(c.port, 10);
                            if (!isNaN(pNum) && pNum > maxPortNumber) maxPortNumber = pNum;
                        });
                        var newPortNum = (maxPortNumber + 1).toString().padStart(2, "0");

                        nodeData.ch.push({
                            port: newPortNum,
                            segment: "",
                            trunk: "N",
                            status: "N",
                            ip: "",
                            keterangan: "",
                        });

                        renderChInputs(nodeData.ch, "edit", nodeData);
                        showMessage("Port baru berhasil ditambahkan", "success");
                    } catch (error) {
                        console.error("Error adding port:", error);
                        showMessage("Error dalam menambah port: " + error.message, "error");
                    }
                });

                // Update port and node info
                $("#btn-update-ch").on("click", function () {
                    try {
                        clearValidationErrors();
                        var nodeName = $("#selected-node").val();
                        if (!nodeName) {
                            showMessage("Tidak ada node yang dipilih", "error");
                            return;
                        }

                        var nodeData = findNodeDataByName(datascource, nodeName);
                        if (!nodeData) {
                            showMessage("Data node yang dipilih tidak ditemukan", "error");
                            return;
                        }

                        var oldName = nodeData.name;
                        var newName = $("#node-name").val().trim();
                        var newIP = $("#node-ip").val().trim();
                        var newSN = $("#node-sn").val().trim();

                        // Validate new name and IP
                        if (!validateSwitchName(newName)) {
                            showValidationError($("#node-name"), "Format nama switch tidak valid");
                            showMessage("Nama switch tidak valid", "error");
                            return;
                        }

                        if (!validateIP(newIP)) {
                            showValidationError($("#node-ip"), "Format IP address tidak valid");
                            showMessage("IP address tidak valid", "error");
                            return;
                        }

                        if (!validateSwitchName(newSN)) {
                            showValidationError($("#node-sn"), "Format SN tidak valid");
                            showMessage("SN switch tidak valid", "error");
                            return;
                        }

                        // === Check for duplicates (excluding current node) ===
                        if (newName !== oldName && checkDuplicateName(newName, oldName)) {
                            showValidationError($("#node-name"), "Nama switch sudah ada");
                            showMessage(`Nama switch "${newName}" sudah ada`, "error");
                            return;
                        }

                        if (newIP !== nodeData.ip && checkDuplicateIP(newIP, oldName)) {
                            showValidationError($("#node-ip"), "IP address sudah digunakan");
                            showMessage(`IP address "${newIP}" sudah digunakan`, "error");
                            return;
                        }

                        if (newSN !== nodeData.sn && checkDuplicateSN(newSN, oldName)) {
                            showValidationError($("#node-sn"), "SN sudah digunakan");
                            showMessage(`SN "${newSN}" sudah digunakan`, "error");
                            return;
                        }

                        nodeData.name = newName;
                        nodeData.ip = newIP;
                        nodeData.jenis = $("#node-jenis").val().trim();
                        nodeData.sn = newSN;

                        // pastikan children tidak hilang
                        if (!nodeData.children) {
                            nodeData.children = [];
                        }

                        var chArray = nodeData.ch;
                        if (!chArray) {
                            showMessage("Node yang dipilih tidak memiliki informasi port", "error");
                            return;
                        }

                        // Validate and update port information
                        var hasError = false;
                        $("#ch-list li").each(function () {
                            var index = $(this).find("input.ch-segment").data("index");
                            if (typeof index !== "undefined" && chArray[index]) {
                                var segmentVal = $(this).find("input.ch-segment").val().trim();
                                var ipVal = $(this).find("input.ch-ip").val().trim();

                                // Validate segment IP if provided
                                if (segmentVal && !validateIP(segmentVal)) {
                                    showValidationError($(this).find("input.ch-segment"), "Format IP segment tidak valid");
                                    hasError = true;
                                }

                                // Validate port IP if provided
                                if (ipVal && !validateIP(ipVal)) {
                                    showValidationError($(this).find("input.ch-ip"), "Format IP port tidak valid");
                                    hasError = true;
                                }

                                if (!hasError) {
                                    chArray[index].segment = segmentVal;
                                    chArray[index].ip = ipVal;
                                    chArray[index].keterangan = $(this).find("input.ch-keterangan").val().trim();
                                    chArray[index].trunk = $(this).find("input.ch-trunk").is(":checked") ? "Y" : "N";
                                    chArray[index].status = $(this).find("input.ch-status").is(":checked") ? "Y" : "N";
                                }
                            }
                        });

                        if (hasError) {
                            showMessage("Harap perbaiki error validasi sebelum menyimpan", "error");
                            return;
                        }

                        // Simpan state collapse sebelum render ulang
                        const collapseState = getCollapseState();

                        // Render ulang chart agar datascource sync
                        renderChart(collapseState);

                        // Update input node terpilih
                        $("#selected-node").val(nodeData.name);

                        if (hasError) {
                            showMessage("Beberapa port gagal diperbarui:\n" + errors.join(", "), "error");
                        } else {
                            showMessage("Informasi port dan node berhasil diperbarui", "success");
                        }
                    } catch (error) {
                        console.error("Error updating port and node info:", error);
                        showMessage("Error dalam memperbarui informasi: " + error.message, "error");
                    }
                });

                // Save all node datasource
                $("#btn-save-ch").on("click", function () {
                    if (confirm("Apakah Anda yakin ingin menyimpan semua data node ini?")) {
                        try {
                            showMessage("Node datasource berhasil disimpan", "success");
                        } catch (error) {
                            console.error("Error saving node:", error);
                            showMessage("Error dalam menyimpan node: " + error.message, "error");
                        }
                    }
                });

                // Port mode change
                $(document).on("change", 'input[name="ch-mode"]', function () {
                    try {
                        var mode = $(this).val();
                        var selectedNodeName = $("#selected-node").val();
                        if (selectedNodeName) {
                            var nodeData = findNodeDataByName(datascource, selectedNodeName);
                            if (nodeData && nodeData.ch) {
                                renderChInputs(nodeData.ch, mode, nodeData);
                                if (mode === "edit") {
                                    $("#ch-add-btn").show();
                                } else {
                                    $("#ch-add-btn").hide();
                                }
                            }
                        }
                    } catch (error) {
                        console.error("Error changing port mode:", error);
                        showMessage("Error dalam mengubah mode port: " + error.message, "error");
                    }
                });

                // Cek apakah sudah login
                const currentUser = localStorage.getItem("loggedInUser");
                if (!currentUser) {
                    window.location.href = "login.html";
                } else {
                    // Set nama user di navbar
                    document.addEventListener("DOMContentLoaded", function () {
                        document.getElementById("user-name").textContent = "Hi, " + currentUser;
                    });
                }

                // === USER MENU TOGGLE ===
                $("#user-name").on("click", function () {
                    $("#logout-menu").toggle();
                });

                // === LOGOUT ACTION ===
                $("#btn-logout").on("click", function () {
                    if (confirm("Apakah Anda yakin ingin logout?")) {
                        // Hapus session user
                        localStorage.removeItem("loggedInUser");

                        // Redirect ke halaman login
                        window.location.href = "login.html";
                    }
                });
            });
        </script>
    </body>
</html>
